<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit&display=swap');
    body {
      font-family: 'Kanit', sans-serif;
      margin: 20px;
      background: #f0f8ff;
      color: #333;
    }
    input, select, button {
      margin: 5px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #007BFF;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    button {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0, 123, 255, 0.2);
    }
    th, td {
      border: 1px solid #dceeff;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #007BFF;
      color: white;
      font-size: 15px;
    }
    #deptSummary {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }
    .summaryBox {
      background: #e9f3ff;
      border: 1px solid #007BFF;
      border-radius: 8px;
      padding: 15px;
      width: 300px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      white-space: pre-line;
    }
    #langSwitcher {
      float: right;
      margin-top: -40px;
      font-weight: bold;
    }
    h2#title {
      margin-bottom: 10px;
      color: #007BFF;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      td {
        text-align: right;
        padding-left: 50%;
        position: relative;
      }
      td::before {
        position: absolute;
        left: 10px;
        font-weight: bold;
        white-space: nowrap;
      }
      td:nth-child(1)::before { content: "‡∏ä‡∏∑‡πà‡∏≠"; }
      td:nth-child(2)::before { content: "‡πÅ‡∏ú‡∏ô‡∏Å"; }
      td:nth-child(3)::before { content: "Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠"; }
      td:nth-child(4)::before { content: "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤"; }
      td:nth-child(5)::before { content: "‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å"; }
      td:nth-child(6)::before { content: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢"; }
      td:nth-child(7)::before { content: "‡∏ö‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å"; }
      td:nth-child(8)::before { content: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏µ‡∏ã‡πà‡∏≤"; }
    }
    @media (max-width: 768px) {
      input, select, button {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
     }
    }
    #suggestionBox div {
       padding: 8px;
       cursor: pointer;
    }
    #suggestionBox div:hover {
       background-color: #e0f0ff;
    }

  </style>
</head>
<body>

<h2 id="title">Employee Thailand</h2>
<select id="langSwitcher" onchange="switchLanguage(this.value)">
  <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
  <option value="en">üá¨üáß English</option>
  <option value="cn">üá®üá≥ ‰∏≠Êñá</option>
</select>

<div>
  <input type="text" id="name" placeholder="üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <select id="department">
    <option value="">üè¢ ‡πÅ‡∏ú‡∏ô‡∏Å</option>
    <option>Texture</option>
    <option>Diffusion</option>
    <option>PECVD</option>
    <option>Print Screen</option>
    <option>Process</option>
    <option>Production</option>
  </select>
  <select id="shirtSize">
    <option value="">üëï Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠</option>
    <option>S</option><option>M</option><option>L</option>
    <option>XL</option><option>2XL</option><option>3XL</option>
    <option>4XL</option><option>5XL</option>
  </select>
  <input type="number" id="shoeSize" placeholder="üëü ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤">
  <input type="text" id="residence" placeholder="üè† ‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å">
  <label for="arrivalDate">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢:</label>
  <input type="date" id="arrivalDate">
  <select id="visaType">
    <option value="">üõÇ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏µ‡∏ã‡πà‡∏≤</option>
    <option value="business">Business Visa</option>
    <option value="E2">E-2 Visa</option>
  </select>
  <button onclick="addData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button onclick="exportToExcel()">üì§ Export Excel</button>
  <button onclick="exportToJSON()">üì¶ Export JSON</button>
  <button onclick="triggerImport()">üì• Import JSON</button>
  <input type="file" id="importJSON" onchange="importFromJSON(event)" style="display: none;">
  <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡πÅ‡∏ú‡∏ô‡∏Å..." onkeyup="searchTable()">
  <button onclick="summarizeByDepartment()">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</button>
  <button onclick="hideSummary()">‚ùå ‡∏õ‡∏¥‡∏î‡∏™‡∏£‡∏∏‡∏õ</button>
  <button onclick="clearAll()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <div id="deptSummary"></div>
  
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤</th>
      <th>‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢</th><th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡∏ö‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏µ‡∏ã‡πà‡∏≤</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- üîî POPUP ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); z-index:9998;" onclick="closePopup()"></div>
<div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:#fff; padding:20px 30px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:9999; text-align:center; font-size:18px; font-weight:bold;">
  <img id="popupImage" src="" alt="‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="max-width:150px; margin-bottom:10px; display:none;"><br>
  <span id="popupText"></span><br><br>
  <button onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
</div>

<script>
const tableBody = document.querySelector("#dataTable tbody");

function switchLanguage(lang) {
  const texts = {
    th: ["‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡πÅ‡∏ú‡∏ô‡∏Å", "Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤", "‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢", "‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡∏ö‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏µ‡∏ã‡πà‡∏≤", "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"],
    en: ["Name", "Department", "Shirt Size", "Shoe Size", "Residence", "Arrival Date", "Departure Date", "Visa Type", "Actions"],
    cn: ["ÂßìÂêç", "ÈÉ®Èó®", "Ë°£ÊúçÂ∞∫ÂØ∏", "ÈûãÁ†Å", "‰ΩèÂÆø", "ÂÖ•Â¢ÉÊó•Êúü", "Âá∫Â¢ÉÊó•Êúü", "Á≠æËØÅÁ±ªÂûã", "Êìç‰Ωú"]
  };
  const ths = document.querySelectorAll("#dataTable thead th");
  ths.forEach((th, i) => th.innerText = texts[lang][i]);
  document.getElementById("title").innerText = {
    th: "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    en: "Employee Management System",
    cn: "ÂëòÂ∑•ÁÆ°ÁêÜÁ≥ªÁªü"
  }[lang];
}

function addData() {
  const name = document.getElementById("name").value.trim();
  const dept = document.getElementById("department").value;
  const shirt = document.getElementById("shirtSize").value;
  const shoe = document.getElementById("shoeSize").value;
  const house = document.getElementById("residence").value;
  const arrival = document.getElementById("arrivalDate").value;
  const visa = document.getElementById("visaType").value;

  if (!name || !dept || !shirt || !shoe || !house || !arrival || !visa) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å localStorage
  const data = JSON.parse(localStorage.getItem("employeeData") || "[]");
  const existingNames = data.map(row => row[0]);
  if (existingNames.includes(name)) {
    alert("‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    return;
  }

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const arrivalDate = new Date(arrival);
  arrivalDate.setHours(0, 0, 0, 0);
  if (arrivalDate > today) {
    alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô");
    return;
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  let departureStr = "";
  if (visa === "business") {
    const departureDate = new Date(arrivalDate);
    departureDate.setDate(departureDate.getDate() + 90);
    departureStr = departureDate.toISOString().split("T")[0];
  } else if (visa === "E2") {
    const expiryDate = new Date(arrivalDate);
    expiryDate.setMonth(expiryDate.getMonth() + 6);
    departureStr = expiryDate.toISOString().split("T")[0];
  }

  const existing = data.find(row => row[0] === name && row[1] === dept);
  if (existing) {
  alert("‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
  return;
  }

  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  if (arrivalDate < sixMonthsAgo) {
  alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á");
  return;
  }


  const row = tableBody.insertRow();
  row.insertCell(0).innerText = name;
  row.insertCell(1).innerText = dept;
  row.insertCell(2).innerText = shirt;
  row.insertCell(3).innerText = shoe;
  row.insertCell(4).innerText = house;
  row.insertCell(5).innerText = arrival;
  row.insertCell(6).innerText = departureStr;
  row.insertCell(7).innerText = visa;

  const manageCell = row.insertCell(8);
  const delBtn = document.createElement("button");
  delBtn.textContent = "‡∏•‡∏ö";
  delBtn.onclick = (event) => {
    event.stopPropagation();
    if (confirm("‚ùó ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
      row.onclick = null;
      row.remove();
      saveToLocal();
    }
  };
  manageCell.appendChild(delBtn);
  manageCell.appendChild(createEditButton(row));

  row.onclick = () => showWarning(name, arrival, visa);
  saveToLocal();
  document.querySelectorAll("input, select").forEach(el => el.value = "");
}

function createEditButton(row) {
  const btn = document.createElement("button");
  btn.textContent = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
  btn.onclick = () => {
    const cells = row.cells;
    document.getElementById("name").value = cells[0].innerText;
    document.getElementById("department").value = cells[1].innerText;
    document.getElementById("shirtSize").value = cells[2].innerText;
    document.getElementById("shoeSize").value = cells[3].innerText;
    document.getElementById("residence").value = cells[4].innerText;
    document.getElementById("arrivalDate").value = cells[5].innerText;
    document.getElementById("visaType").value = cells[7].innerText;

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    closePopup();
    row.onclick = null;

    row.remove();
    saveToLocal();
  };
  return btn;
}

function showWarning(name, arrival, visaType, imageUrl = "") {
  const arrivalDate = new Date(arrival);
  let message = "";

  if (!visaType) {
    message = `‚ö†Ô∏è ${name}: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏µ‡∏ã‡πà‡∏≤`;
  } else if (visaType === "business") {
    const warnStart = new Date(arrivalDate);
    const warnEnd = new Date(arrivalDate);
    warnStart.setDate(warnStart.getDate() + 80);
    warnEnd.setDate(warnEnd.getDate() + 90);
    message = `üîî ${name}:\n‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏ö‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á\n${warnStart.toLocaleDateString()} ‡∏ñ‡∏∂‡∏á ${warnEnd.toLocaleDateString()}`;
  } else if (visaType === "E2") {
    const expire = new Date(arrivalDate);
    expire.setMonth(expire.getMonth() + 6);
    const warn = new Date(expire);
    warn.setDate(warn.getDate() - 10);
    message = `üîî ${name}:\n‡∏ß‡∏µ‡∏ã‡πà‡∏≤ E-2 ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expire.toLocaleDateString()}\n(‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ${warn.toLocaleDateString()})`;
  }

  document.getElementById("popupText").innerText = message;
  const popupImage = document.getElementById("popupImage");
  popupImage.style.display = "none";
  document.getElementById("popup").style.display = "block";
  document.getElementById("popupOverlay").style.display = "block";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
  document.getElementById("popupOverlay").style.display = "none";
}

function saveToLocal() {
  const data = Array.from(tableBody.rows).map(row =>
    Array.from(row.cells).slice(0, 8).map(cell => cell.innerText)
  );
  localStorage.setItem("employeeData", JSON.stringify(data));
}

function loadFromLocal() {
  const data = JSON.parse(localStorage.getItem("employeeData") || "[]");
  data.forEach(rowData => {
    const row = tableBody.insertRow();
    rowData.forEach(text => row.insertCell().innerText = text);
    const manageCell = row.insertCell();

    // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® delBtn ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const delBtn = document.createElement("button");
    delBtn.textContent = "‡∏•‡∏ö";
    delBtn.onclick = (event) => {
  event.stopPropagation();
  if (confirm("‚ùó ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
    row.onclick = null;
    row.remove();
    saveToLocal();
  }
};


    manageCell.appendChild(delBtn);
    manageCell.appendChild(createEditButton(row));
    row.onclick = () => showWarning(rowData[0], rowData[5], rowData[7]);
  });
}
window.onload = loadFromLocal;

function exportToExcel() {
  const wb = XLSX.utils.book_new();
  const ws_name = "Employees";

  const headers = ["‡∏ä‡∏∑‡πà‡∏≠", "‡πÅ‡∏ú‡∏ô‡∏Å", "Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠", "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤", "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", "‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢", "‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡∏ö‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å", "‡∏ß‡∏µ‡∏ã‡πà‡∏≤"];
  const data = [headers];
  Array.from(tableBody.rows).forEach(row => {
    data.push(Array.from(row.cells).slice(0, 8).map(cell => cell.innerText));
  });

  const ws = XLSX.utils.aoa_to_sheet(data);

  ws['!cols'] = [
    { wch: 25 }, // ‡∏ä‡∏∑‡πà‡∏≠
    { wch: 15 }, // ‡πÅ‡∏ú‡∏ô‡∏Å
    { wch: 10 }, // Size ‡πÄ‡∏™‡∏∑‡πâ‡∏≠
    { wch: 10 }, // ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤
    { wch: 15 }, // ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
    { wch: 15 }, // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢
    { wch: 18 }, // ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    { wch: 12 }  // ‡∏ß‡∏µ‡∏ã‡πà‡∏≤
  ];

  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
    if (!ws[cellAddress]) continue;
    ws[cellAddress].s = {
      font: { bold: true, color: { rgb: "FFFFFF" } },
      alignment: { horizontal: "center", vertical: "center" },
      fill: { fgColor: { rgb: "007BFF" } }
    };
  }

  for (let R = 1; R <= range.e.r; ++R) {
    for (let C = 0; C <= range.e.c; ++C) {
      const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
      if (ws[cellAddress]) {
        ws[cellAddress].s = {
          alignment: { horizontal: "center", vertical: "center" }
        };
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, ws_name);
  XLSX.writeFile(wb, "employee_data.xlsx");
}

function exportToJSON() {
  const data = localStorage.getItem("employeeData");
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "employeeData.json";
  a.click();
}

function importFromJSON(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = function (e) {
    const json = e.target.result;
    localStorage.setItem("employeeData", json);
    location.reload();
  };
  reader.readAsText(file);
}

function triggerImport() {
  document.getElementById("importJSON").click();
}

function searchTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = tableBody.getElementsByTagName("tr");
  Array.from(rows).forEach(row => {
    const text = Array.from(row.cells).slice(0, 8)
      .map(cell => cell.innerText.toLowerCase()).join(" ");
    row.style.display = text.includes(input) ? "" : "none";
  });
}

function summarizeByDepartment() {
  const summary = {};
  const today = new Date();
  Array.from(tableBody.rows).forEach(row => {
    const dept = row.cells[1].innerText;
    const visa = row.cells[7].innerText;
    const house = row.cells[4].innerText;
    const shirt = row.cells[2].innerText;
    const departure = new Date(row.cells[6].innerText);
    if (!summary[dept]) {
      summary[dept] = {
        count: 0,
        visas: {}, houses: new Set(),
        shirts: {}, visaExpiringSoon: 0
      };
    }
    summary[dept].count++;
    summary[dept].visas[visa] = (summary[dept].visas[visa] || 0) + 1;
    summary[dept].houses.add(house);
    summary[dept].shirts[shirt] = (summary[dept].shirts[shirt] || 0) + 1;
    const diffDays = (departure - today) / (1000 * 60 * 60 * 24);
    if (diffDays <= 10 && diffDays >= 0) {
      summary[dept].visaExpiringSoon++;
    }
  });

  const container = document.getElementById("deptSummary");
  container.innerHTML = "";
  for (let dept in summary) {
    const box = document.createElement("div");
    box.className = "summaryBox";
    box.innerText = `üìÅ ‡πÅ‡∏ú‡∏ô‡∏Å: ${dept}\nüë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${summary[dept].count}\nüè† ‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å: ${Array.from(summary[dept].houses).join(", ")}\nüß• ‡πÄ‡∏™‡∏∑‡πâ‡∏≠: ${Object.entries(summary[dept].shirts).map(([s, c]) => `${s}(${c})`).join(", ")}\nüõÇ ‡∏ß‡∏µ‡∏ã‡πà‡∏≤: ${Object.entries(summary[dept].visas).map(([v, c]) => `${v}(${c})`).join(", ")}\n‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏ß‡∏µ‡∏ã‡πà‡∏≤: ${summary[dept].visaExpiringSoon}`;
    container.appendChild(box);
  }
}

function hideSummary() {
  document.getElementById("deptSummary").innerHTML = "";
}

window.onload = () => {
  loadFromLocal();
  const lang = navigator.language.startsWith("en") ? "en" : navigator.language.startsWith("zh") ? "cn" : "th";
  switchLanguage(lang);
  document.getElementById("langSwitcher").value = lang;
};

function clearAll() {
  if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
    localStorage.removeItem("employeeData");
    location.reload();
  }
}
function showSuggestions(inputText) {
  const suggestionBox = document.getElementById("suggestionBox");
  suggestionBox.innerHTML = "";
  if (!inputText.trim()) {
    suggestionBox.style.display = "none";
    return;
  }

  const lower = inputText.toLowerCase();
  const suggestions = new Set();

  Array.from(tableBody.rows).forEach(row => {
    const name = row.cells[0].innerText;
    const dept = row.cells[1].innerText;
    if (name.toLowerCase().includes(lower)) suggestions.add(name);
    if (dept.toLowerCase().includes(lower)) suggestions.add(dept);
  });

  if (suggestions.size === 0) {
    suggestionBox.style.display = "none";
    return;
  }

  suggestions.forEach(text => {
    const div = document.createElement("div");
    div.textContent = text;
    div.onclick = () => {
      document.getElementById("searchInput").value = text;
      suggestionBox.style.display = "none";
      searchTable();
    };
    suggestionBox.appendChild(div);
  });

  const inputRect = document.getElementById("searchInput").getBoundingClientRect();
  suggestionBox.style.left = inputRect.left + "px";
  suggestionBox.style.top = (inputRect.bottom + window.scrollY) + "px";
  suggestionBox.style.width = inputRect.width + "px";
  suggestionBox.style.display = "block";
}

// ‡∏ã‡πà‡∏≠‡∏ô suggestion ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
  document.addEventListener("click", function(e) {
  if (!e.target.closest("#searchInput") && !e.target.closest("#suggestionBox")) {
    document.getElementById("suggestionBox").style.display = "none";
  }
});
// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå employeeData.json ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô localStorage
async function loadFromExternalJSON() {
  const local = localStorage.getItem("employeeData");
  if (!local || local === "[]") {
    try {
      const response = await fetch("employeeData.json");
      const data = await response.json();
      localStorage.setItem("employeeData", JSON.stringify(data));
      location.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    } catch (error) {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î employeeData.json ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
    }
  }
}

window.onload = async () => {
  await loadFromExternalJSON();
  loadFromLocal(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
  const lang = navigator.language.startsWith("en") ? "en" : navigator.language.startsWith("zh") ? "cn" : "th";
  switchLanguage(lang);
  document.getElementById("langSwitcher").value = lang;
};

</script>

</body>
</html>
